<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="shared-styles.html">
<dom-module id="page-transfer">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-alignment app-grid-style"></style>
        <style include="shared-styles">
         :host {
            display: block;
        }

        .container {
            @apply(--layout-horizontal);
            @apply(--layout-center-justified);
            margin: 50px;
        }

        .flexleft {
            @apply(--layout-vertical);
            width: 400px;
            #background-color: mediumvioletred;
        }

        .flexright {
            @apply(--layout-vertical);
            width: 500px;
            padding-left: 40px;
            margin-left: 100px;
            #background-color: #b0e0e6;
        }

        .flexright>.hr {
            width: 350px;
        }

        .fontContent {
            font-family: Georgia, serif;
            font-size: 0.875em;
        }

        iron-list {
            flex: 1 1 auto;
        }

        .hidden {
            display: none;
        }

        iron-input>input {
            width: 350px;
            height: 34px;
            padding-bottom: 0px;
        }

        iron-input>.amount {
            width: 150px;
            height: 34px;
            padding-bottom: 0px;
        }

        iron-input[invalid]>input {
            border: 1px solid red;
            background-color: #FFCDD2;
        }

        .line {
            @apply(--layout-horizontal);
            @apply(--layout-start-justified);
            margin-top: 10px;
        }

        .lineHoriziontal {
            @apply(--layout-horizontal);
            @apply(--layout-center-justified);
            margin-top: 20px;
        }

        .selectBox {
            padding-bottom: 1px;
        }
        </style>
        <looper-page>
            <global-variable key="wallet" value="{{wallet}}"></global-variable>
            <global-variable key="app-config" value="{{appConfig}}"></global-variable>
            <simple-toolbar slot="secondary-toolbar" title="Transfer" back-link="#/wallet"></simple-toolbar>
            <div class="sections">
                <paper-card>
                    <div class="container">
                        <div class="flexleft">
                            <div class="line">
                                Send To:
                            </div>
                            <div class="line">
                                <iron-input bind-value="{{bindValue}}">
                                    <input value="{{value::input}}">
                                </iron-input>
                            </div>
                            <div class="line">
                                Amount to Send:
                            </div>
                            <div class="line">
                                <iron-input bind-value="{{bindValue}}">
                                    <input value="{{value::input}}" class="amount">
                                </iron-input>
                                <div class="selectBox">
                                    <vaadin-combo-box id="tokensSelector" items="[[_toTokenNameArray(appConfig.tokens)]]" item-label-path="name" item-value-path="address"></vaadin-combo-box>
                                </div>
                            </div>
                            <div class="line">
                                Gas Limit:
                            </div>
                            <div class="line">
                                <iron-input bind-value="{{bindValue}}">
                                    <input value="{{value::input}}">
                                </iron-input>
                            </div>
                            <div class="line">
                                <a on-click="handleClick">+Advanced: Add Data</a>
                            </div>
                            <div class="hidden" id="hiddenExtData">
                                <div class="line">
                                    Data:
                                </div>
                                <div class="line">
                                    <iron-input bind-value="{{bindValue}}">
                                        <input value="{{value::input}}">
                                    </iron-input>
                                </div>
                            </div>
                            <div class="lineHoriziontal">
                                <paper-button raised on-click="signToSend">Generate Transaction</paper-button>
                            </div>
                        </div>
                        <div class="flexright">
                            <paper-item class="flex">
                                <paper-item-body two-line>
                                    <div class="title"> Account Address</div>
                                    <div secondary>
                                        [[wallet.address]]
                                    </div>
                                </paper-item-body>
                            </paper-item>
                            <paper-item class="flex">
                                <paper-item-body two-line>
                                    <div class="title"> Account Balance</div>
                                    <div secondary>0</div>
                                </paper-item-body>
                            </paper-item>
                            <div class="hr">
                                <hr>
                            </div>
                            <paper-item class="flex">
                                <paper-item-body two-line>
                                    <div class="title"> Token Balances</div>
                                    <div secondary>
                                        <iron-ajax url="https://raw.githubusercontent.com/Loopring/mock-relay-data/master/walletTokens.json" last-response="{{data}}" auto></iron-ajax>
                                        <iron-list items="[[data.result.tokens]]" as="item">
                                            <template>
                                                <div class="fontContent">
                                                    [[_findSymbol(item.contract)]] [[item.balance]]
                                                </div>
                                            </template>
                                        </iron-list>
                                    </div>
                                </paper-item-body>
                            </paper-item>
                        </div>
                    </div>
                </paper-card>
                <div class="footer-spacer"></div>
                <looper-footer></looper-footer>
            </div>
        </looper-page>
    </template>
    <script>
    class PageTransfer extends Polymer.Element {
        static get is() { return 'page-transfer'; }

        ready() {
            super.ready();
            var combobox = this.$.tokensSelector
            var context = this
            combobox.addEventListener('value-changed', function() {
                context.selectedToken = combobox.value;
                console.log("selected token:"+context.selectedToken)
            });
        }

        handleClick() {
            var extData = this.$.hiddenExtData;
            if (extData.style.display == 'block') {
                extData.style.display = 'none';
            } else {
                extData.style.display = 'block';
            }
        }

        _toTokenNameArray(obj) {
            if(!obj) return;
            let array = Object.keys(obj).map(function(key) {
                return {
                    name: key,
                    address: obj[key].contract
                };
            });
            return array.filter(function(item){
                return item.name != "ETH"
            });
        }

        _findTokenConfig(address) {
            var tokens = this.appConfig.tokens;
            for (var x in tokens) {
                var token = tokens[x];
                if (token.contract == address) {
                    return token;
                }
            }
        }

        _toLowerSymbol(address) {
            var token = this._findTokenConfig(address);
            if (token) {
                return token.unit.toLowerCase()
            } else {
                return "?";
            }
        }

        _findSymbol(address) {
            var token = this._findTokenConfig(address);
            if (token) {
                return token.unit
            } else {
                return "?";
            }
        }

        signToSend() {
            var detail = { raw: "raw message" };
            this.dispatchEvent(new CustomEvent('signtosend', { bubbles: true, composed: true, detail: detail }));
        }
    }
    window.customElements.define(PageTransfer.is, PageTransfer);
    </script>
</dom-module>